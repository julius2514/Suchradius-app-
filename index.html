<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<title>Suchradius mit Overlay-Suchgebieten</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<style>
body { margin:0; font-family:Arial,Helvetica,sans-serif; height:100vh; display:flex; gap:16px; background: linear-gradient(135deg,#dbeafe,#ccfbf1); padding:16px; box-sizing:border-box; }
.sidebar { width:360px; background:#fff; border-radius:12px; padding:18px; box-shadow:0 8px 24px rgba(2,6,23,0.08); overflow:auto; display:flex; flex-direction:column; justify-content:space-between; }
.mapwrap { flex:1; background:#fff; border-radius:12px; box-shadow:0 8px 24px rgba(2,6,23,0.08); display:flex; flex-direction:column; }
#map { flex:1; border-radius:12px; }
h2{ margin:0 0 12px; color:#0b1220; text-align:center;}
label{display:block; margin-top:10px; font-weight:700; color:#0b1220;}
input[type=text], input[type=number], select, button { width:100%; padding:8px; margin-top:6px; border-radius:8px; border:1px solid #d1d5db; box-sizing:border-box; font-size:14px; }
button { background:linear-gradient(90deg,#3b82f6,#14b8a6); color:#fff; font-weight:700; cursor:pointer; border:none; }
button.secondary { background:linear-gradient(90deg,#64748b,#94a3b8); margin-top:8px; }
.status { margin-top:12px; font-weight:700; text-align:center; color:#0b1220; }
.spinner { border:4px solid #f3f3f3; border-top:4px solid #3b82f6; border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite; margin:8px auto; display:none; }
@keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

/* Karten (Bausteine) */
.card { background:#f8fafc; padding:14px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 8px rgba(2,6,23,0.04); position:relative; }
.card h3 { margin:-14px -14px 12px -14px; padding:8px 12px; font-size:15px; font-weight:700; color:#fff; border-top-left-radius:8px; border-top-right-radius:8px; }
.card.einsatzort { border:2px solid #facc15; }
.card.einsatzort h3 { background:linear-gradient(90deg,#facc15,#fbbf24); }
.card.personen { border:2px solid #3b82f6; }
.card.personen h3 { background:linear-gradient(90deg,#3b82f6,#2563eb); }
.card.berechnung { border:2px solid #22c55e; }
.card.berechnung h3 { background:linear-gradient(90deg,#22c55e,#16a34a); }
.card.suchgebiete { border:2px solid #ef4444; }
.card.suchgebiete h3 { background:linear-gradient(90deg,#ef4444,#dc2626); }
small.hint { color:#475569; display:block; margin-top:6px; }
.distance { margin-top:10px; font-weight:700; text-align:center; color:#1e3a8a; }
</style>
</head>
<body>
<div class="sidebar">
<h2>Suchradiusgenerator</h2>

<div class="card einsatzort">
<h3>Einsatzort</h3>
<label for="place">Ort:</label>
<input type="text" id="place" placeholder="z. B. Landau in der Pfalz">
<label for="address">Adresse:</label>
<input type="text" id="address" placeholder="z. B. Hauptstra√üe 12">
<label><input type="checkbox" id="clickEnabled"> Linksklick setzt Einsatzstelle</label>
<button id="btnSearch" onclick="searchLocation()">üîé Suchen</button>
<small class="hint">Alternativ: Karte klicken, wenn aktiviert.</small>
</div>

<div class="card personen">
<h3>Personenangaben</h3>
<label for="age">Alter der Person</label>
<input id="age" type="number" value="80" min="0" max="120">
<label for="mode">Fortbewegungsmittel</label>
<select id="mode"><option value="foot-walking">Zu Fu√ü</option></select>
<label for="hours">Vermisst seit (Stunden)</label>
<input id="hours" type="number" value="6" min="0.1" step="0.1">
<small class="hint">Die App rechnet mit konservativen Durchschnittsgeschwindigkeiten.</small>
</div>

<div class="card berechnung">
<h3>Berechnung</h3>
<label><input id="barriers" type="checkbox"> Barrieren ber√ºcksichtigen</label>
<button onclick="calculate()">üîç Isochrone berechnen</button>
<div id="distanceInfo" class="distance"></div>
<div class="status" id="status">Bereit</div>
<div class="spinner" id="spinner"></div>
</div>

<div class="card suchgebiete">
<h3>Suchgebiete</h3>
<label><input id="splitEnabled" type="checkbox"> Overlay einblenden</label>
<label for="splitCount">Anzahl Suchgebiete</label>
<select id="splitCount">
<option value="2">2</option>
<option value="4">4</option>
<option value="6">6</option>
<option value="8">8</option>
<option value="10">10</option>
<option value="12">12</option>
</select>
<small class="hint">Das Overlay wird gleichm√§√üig √ºber der Isochrone angezeigt.</small>
</div>

<button class="secondary" onclick="showLegend()">üìò Legende</button>
</div>

<div class="mapwrap">
<div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script>
const ORS_API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjIwNjhjODIwMWIwYTRhOTJiMWJjNjEwNWM4Mzk1YTY5IiwiaCI6Im11cm11cjY0In0=";

const map = L.map('map').setView([49.1989, 8.1169], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'¬© OpenStreetMap'}).addTo(map);

let startMarker=null, isoLayer=null, overlayLayer=null, startCoords=null;

map.on('click', e=>{
  if(document.getElementById('clickEnabled').checked){
    startCoords={lat:e.latlng.lat,lng:e.latlng.lng};
    if(startMarker) map.removeLayer(startMarker);
    startMarker=L.marker([startCoords.lat,startCoords.lng]).addTo(map).bindPopup('Einsatzort').openPopup();
  }
});

function setStatus(txt){ document.getElementById('status').textContent=txt; }
function showSpinner(on){ document.getElementById('spinner').style.display=on?'block':'none'; }
function getBaseSpeedKmh(age){ return age<=6?2:age<=12?3:age<=17?4:age<=39?4.5:age<=59?4:age<=79?3:2; }
function getFatigueFactor(age){ return age<=12?3:age<=59?6:age<=79?4:2.5; }
function calculateDistanceKm(age,hours){ const base=getBaseSpeedKmh(age); const fatigue=getFatigueFactor(age); return base*(1/(1+(hours/fatigue)))*hours; }
function generateDistinctColors(count){ const colors=[]; const step=360/count; for(let i=0;i<count;i++){colors.push(`hsl(${i*step},70%,60%)`);} return colors; }

// Overlay-Funktion
function createOverlayAreasComplete(polygon, count){
  if(!polygon) return [];
  const bbox=turf.bbox(polygon);
  let overlays=[]; let cols=Math.ceil(Math.sqrt(count)); let rows=Math.ceil(count/cols);
  while((cols-1)*rows>=count) cols--;
  const dx=(bbox[2]-bbox[0])/cols; const dy=(bbox[3]-bbox[1])/rows;
  let n=0;
  for(let j=0;j<rows;j++){
    for(let i=0;i<cols;i++){
      if(n>=count) break;
      const x0=bbox[0]+i*dx, y0=bbox[1]+j*dy;
      const x1=(i===cols-1)?bbox[2]:x0+dx, y1=(j===rows-1)?bbox[3]:y0+dy;
      const rect=turf.bboxPolygon([x0,y0,x1,y1]);
      const clipped=turf.intersect(polygon,rect);
      if(clipped) overlays.push(clipped);
      n++;
    }
  }
  if(overlays.length<count){
    let missing=count-overlays.length;
    const diff=turf.difference(polygon,turf.union(...overlays));
    if(diff){
      const extra=createOverlayAreasComplete(diff,missing);
      overlays.push(...extra);
    }
  }
  return overlays;
}

function updateOverlay(){
  if(!isoLayer) return;
  if(overlayLayer) map.removeLayer(overlayLayer);
  if(!document.getElementById('splitEnabled').checked) return;
  const count=parseInt(document.getElementById('splitCount').value);
  const overlays=createOverlayAreasComplete(turf.feature(isoLayer.toGeoJSON().features[0].geometry),count);
  const colors=generateDistinctColors(overlays.length);
  overlayLayer=L.geoJSON(overlays,{
    style:(feature)=>{ const idx=overlays.indexOf(feature); return {color:'#000',weight:2,fillOpacity:0.25,fillColor:colors[idx]}; }
  }).addTo(map);
}

document.getElementById('splitEnabled').addEventListener('change',updateOverlay);
document.getElementById('splitCount').addEventListener('change',updateOverlay);

async function calculate(){
  if(!startCoords){ alert('Bitte Einsatzort setzen.'); return;}
  const age=Number(document.getElementById('age').value)||30;
  const hours=Number(document.getElementById('hours').value)||1;
  const distanceKm=calculateDistanceKm(age,hours);
  const distanceM=Math.round(distanceKm*1000);
  document.getElementById('distanceInfo').textContent=`Maximale Distanz: ${distanceKm.toFixed(2)} km`;
  setStatus(`‚è≥ Berechne Isochrone f√ºr ${distanceKm.toFixed(2)} km ‚Ä¶`);
  showSpinner(true);
  if(isoLayer) map.removeLayer(isoLayer);
  if(overlayLayer) map.removeLayer(overlayLayer);
  try{
    const orsRes=await fetch('https://api.openrouteservice.org/v2/isochrones/foot-walking',{
      method:'POST',
      headers:{'Authorization':ORS_API_KEY,'Content-Type':'application/json'},
      body:JSON.stringify({locations:[[startCoords.lng,startCoords.lat]],range:[distanceM],range_type:'distance',units:'m'})
    });
    if(!orsRes.ok) throw new Error(await orsRes.text());
    const data=await orsRes.json();
    const basePoly=turf.feature(data.features[0].geometry);
    isoLayer=L.geoJSON(basePoly,{style:{color:'#ef4444',weight:2,fillOpacity:0.18}}).addTo(map);
    updateOverlay();
    map.fitBounds(isoLayer.getBounds());
    setStatus('‚úî Fertig ‚Äî Isochrone angezeigt.');
  }catch(err){ console.error(err); setStatus('‚ùå Fehler bei Berechnung'); alert('Fehler bei der Berechnung ‚Äî siehe Konsole.');}
  finally{ showSpinner(false);}
}

async function searchLocation(){
  const query=[document.getElementById('place').value.trim(),document.getElementById('address').value.trim()].filter(Boolean).join(", ");
  if(!query) return alert('Bitte Ort oder Adresse eingeben');
  setStatus('üîé Suche Ort‚Ä¶');
  try{
    const resp=await fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(query));
    const arr=await resp.json();
    if(!arr || arr.length===0){ setStatus('Ort nicht gefunden'); return;}
    const first=arr[0]; startCoords={lat:parseFloat(first.lat),lng:parseFloat(first.lon)};
    if(startMarker) map.removeLayer(startMarker);
    startMarker=L.marker([startCoords.lat,startCoords.lng]).addTo(map).bindPopup(first.display_name).openPopup();
    map.setView([startCoords.lat,startCoords.lng],13);
    setStatus('Ort gesetzt');
  }catch(err){ console.error(err); setStatus('Fehler bei Ortssuche'); }
}

function showLegend(){
  const w=window.open('','Legende','width=420,height=520');
  w.document.write(`<html><head><meta charset="utf-8"><title>Legende</title><style>body{font-family:Arial;padding:12px}table{border-collapse:collapse;width:100%}th,td{border:1px solid #ccc;padding:6px;text-align:center}</style></head><body><h3>Geschwindigkeitstabellen</h3><table><tr><th>Alter</th><th>Zu Fu√ü (km/h)</th></tr><tr><td>0‚Äì6</td><td>2.0</td></tr><tr><td>7‚Äì12</td><td>3.0</td></tr><tr><td>13‚Äì17</td><td>4.0</td></tr><tr><td>18‚Äì39</td><td>4.5</td></tr><tr><td>40‚Äì59</td><td>4.0</td></tr><tr><td>60‚Äì79</td><td>3.0</td></tr><tr><td>80+</td><td>2.0</td></tr></table></body></html>`);
}
</script>
</body>
</html>
